# name: Build and Deploy Flask App to Azure

# on:
#   push:
#     branches:
#       - main

# env:
#   RESOURCE_GROUP: Carlsberg-test
#   ACR_NAME: flaskregistrykjadhav777
#   WEB_APP_NAME: flask-app-kjadhav777
#   IMAGE_NAME: flask-python-app
#   IMAGE_TAG: v1

# jobs:
#   build-and-deploy:
#     runs-on: ubuntu-latest

#     steps:
#     - name: Checkout source
#       uses: actions/checkout@v4

#     - name: Azure Login
#       uses: azure/login@v1
#       with:
#         creds: ${{ secrets.AZURE_CREDENTIALS }}

#     - name: Login to ACR
#       run: |
#         az acr login --name $ACR_NAME

#     - name: Build and Push Docker Image
#       run: |
#         docker build -t $ACR_NAME.azurecr.io/$IMAGE_NAME:$IMAGE_TAG .
#         docker push $ACR_NAME.azurecr.io/$IMAGE_NAME:$IMAGE_TAG

#     - name: Deploy to Azure Web App
#       uses: azure/webapps-deploy@v2
#       with:
#         app-name: ${{ env.WEB_APP_NAME }}
#         images: ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

#     - name: Configure App Settings
#       run: |
#         az webapp config appsettings set \
#           --resource-group $RESOURCE_GROUP \
#           --name $WEB_APP_NAME \
#           --settings \
#           WEBSITES_PORT=80 \
#           DOCKER_REGISTRY_SERVER_URL=https://$ACR_NAME.azurecr.io \
#           DOCKER_REGISTRY_SERVER_USERNAME=${{ secrets.ACR_USERNAME }} \
#           DOCKER_REGISTRY_SERVER_PASSWORD=${{ secrets.ACR_PASSWORD }}
##################################################################################
# name: Build and Deploy Flask App to Azure

# on:
#   push:
#     branches:
#       - main

# env:
#   RESOURCE_GROUP: Carlsberg-test
#   ACR_NAME: flaskregistrykjadhav777
#   WEB_APP_NAME: flask-app-kjadhav777
#   IMAGE_NAME: flask-python-app
#   IMAGE_TAG: v1

# jobs:
#   build-and-deploy:
#     runs-on: ubuntu-latest

#     steps:
#     - name: Checkout source
#       uses: actions/checkout@v4

#     - name: Azure Login
#       uses: azure/login@v2
#       with:
#         creds: ${{ secrets.AZURE_CREDENTIALS }}

#     - name: Build & Push Image to ACR
#       run: |
#         az acr build \
#           --registry $ACR_NAME \
#           --image $IMAGE_NAME:$IMAGE_TAG \
#           .

#     - name: Deploy to Azure Web App
#       run: |
#         az webapp config container set \
#           --resource-group $RESOURCE_GROUP \
#           --name $WEB_APP_NAME \
#           --docker-custom-image-name $ACR_NAME.azurecr.io/$IMAGE_NAME:$IMAGE_TAG \
#           --docker-registry-server-url https://$ACR_NAME.azurecr.io

#     - name: Configure App Settings
#       run: |
#         az webapp config appsettings set \
#           --resource-group $RESOURCE_GROUP \
#           --name $WEB_APP_NAME \
#           --settings WEBSITES_PORT=80


###################################################################
name: Flask App Deployment

on:
  push:
    branches:
      - main  # Triggers when you push code to the main branch

env:
  UNIQUE_ID: kjadhav777
  RESOURCE_GROUP: Carlsberg-test
  ACR_NAME: flaskregistrykjadhav777
  WEB_APP_NAME: flask-app-kjadhav777
  SERVICE_PLAN: freeplan-azurewebapplocal

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Build Image in ACR (Step 2 of your .bat)
        run: |
          az acr build --registry ${{ env.ACR_NAME }} --image flask-python-app:v1 .

      - name: Configure Web App & Credentials (Step 3 & 4 of your .bat)
        run: |
          # Get ACR Credentials
          ACR_USERNAME=$(az acr credential show --name ${{ env.ACR_NAME }} --query "username" -o tsv)
          ACR_PASSWORD=$(az acr credential show --name ${{ env.ACR_NAME }} --query "passwords[0].value" -o tsv)
          
          # Update App Settings and Set Image
          az webapp config appsettings set --resource-group ${{ env.RESOURCE_GROUP }} --name ${{ env.WEB_APP_NAME }} \
            --settings DOCKER_REGISTRY_SERVER_URL=https://${{ env.ACR_NAME }}.azurecr.io \
            DOCKER_REGISTRY_SERVER_USERNAME=$ACR_USERNAME \
            DOCKER_REGISTRY_SERVER_PASSWORD=$ACR_PASSWORD \
            WEBSITES_PORT=80
            
          # Deploy the specific container image
          az webapp config container set --name ${{ env.WEB_APP_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} \
            --container-image-name ${{ env.ACR_NAME }}.azurecr.io/flask-python-app:v1